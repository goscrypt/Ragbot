<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transformers.js Complete Multi-Model RAG Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .model-test { 
            border: 1px solid #e0e0e0; 
            padding: 15px; 
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .model-test h2 { 
            margin-top: 0; 
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .loading { color: orange; font-weight: bold; }
        .ready { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ðŸ¤– Transformers.js RAG Core Model Test Suite</h1>
    <p>This page tests the four core models needed for an accurate Retrieval-Augmented Generation (RAG) bot, all running client-side.</p>
    <p>Please open the **browser console** (F12) to view the model output, embeddings, and ranking scores.</p>

    <div id="test-output">
        <div id="test1" class="model-test">
            <h2>1. Feature Extraction (Initial Retrieval)</h2>
            <p id="status1" class="loading">Status: Loading...</p>
            <p><strong>Model:</strong> <code>Xenova/all-MiniLM-L6-v2</code></p>
            <p><strong>Input:</strong> "The project was a huge success."</p>
        </div>
        <div id="test2" class="model-test">
            <h2>2. Sentiment Analysis (Classification/Triage)</h2>
            <p id="status2" class="loading">Status: Loading...</p>
            <p><strong>Model:</strong> <code>Xenova/distilbert-base-uncased-finetuned-sst-2-english</code></p>
            <p><strong>Input:</strong> "I love coding with these new tools!"</p>
            <p id="result2"></p>
        </div>
        <div id="test3" class="model-test">
            <h2>3. Text Generation (Response Synthesis)</h2>
            <p id="status3" class="loading">Status: Loading...</p>
            <p><strong>Model:</strong> <code>Xenova/gpt2</code></p>
            <p><strong>Input Prompt:</strong> "The meaning of life is"</p>
            <p id="result3"></p>
        </div>
        <div id="test4" class="model-test">
            <h2>4. Reranking (Accuracy Check) - **Crucial for RAG**</h2>
            <p id="status4" class="loading">Status: Loading...</p>
            <p><strong>Model:</strong> <code>Xenova/bge-reranker-base</code></p>
            <p><strong>Query:</strong> "How do I install the dependencies for a Python project?"</p>
            <p><strong>Candidate 1:</strong> "Use `pip install -r requirements.txt` to install all project dependencies."</p>
            <p><strong>Candidate 2:</strong> "The project setup requires a version of NodeJS above 18.0."</p>
            <p id="result4"></p>
        </div>
    </div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // --- Helper Function ---
        function updateStatus(id, message, className = 'loading') {
            const el = document.getElementById(`status${id}`);
            if (el) {
                el.textContent = `Status: ${message}`;
                el.className = className;
            }
        }

        // --- Test 1: Feature Extraction (Bi-Encoder) ---
        async function runFeatureExtractionTest() {
            updateStatus(1, 'Downloading and initializing Embedding Model...');
            try {
                const extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
                updateStatus(1, 'Ready!', 'ready');

                const text = 'The project was a huge success.';
                const output = await extractor(text, { pooling: 'mean', normalize: true });
                
                console.log('--- TEST 1: Feature Extraction ---');
                console.log(`Input: "${text}"`);
                console.log(`Embedding Dimensions: [${output.dims.join(', ')}]`);
                console.log(`Embedding (first 5 values): [${output.tolist()[0].slice(0, 5).map(v => v.toFixed(4)).join(', ')}]`);

            } catch (error) {
                updateStatus(1, 'ERROR! Check console.', 'error');
                console.error('Test 1 Error:', error);
            }
        }

        // --- Test 2: Sentiment Analysis ---
        async function runSentimentAnalysisTest() {
            updateStatus(2, 'Downloading and initializing Sentiment Model...');
            try {
                const classifier = await pipeline('sentiment-analysis', 'Xenova/distilbert-base-uncased-finetuned-sst-2-english');
                updateStatus(2, 'Ready!', 'ready');

                const text = 'I love coding with these new tools!';
                const output = await classifier(text);
                
                const result = output[0];
                document.getElementById('result2').innerHTML = `<p><strong>Result:</strong> ${result.label} (Score: ${result.score.toFixed(4)})</p>`;
                
                console.log('\n--- TEST 2: Sentiment Analysis ---');
                console.log(`Input: "${text}"`);
                console.log(`Result: ${result.label} (Score: ${result.score.toFixed(4)})`);


            } catch (error) {
                updateStatus(2, 'ERROR! Check console.', 'error');
                console.error('Test 2 Error:', error);
            }
        }

        // --- Test 3: Text Generation ---
        async function runTextGenerationTest() {
            updateStatus(3, 'Downloading and initializing Text Generation Model...');
            try {
                const generator = await pipeline('text-generation', 'Xenova/gpt2');
                updateStatus(3, 'Ready!', 'ready');

                const prompt = 'The meaning of life is';
                const output = await generator(prompt, { 
                    max_new_tokens: 30,
                    do_sample: true
                });
                
                const generatedText = output[0].generated_text;
                document.getElementById('result3').innerHTML = `<p><strong>Generated Text:</strong> <em>"${generatedText}"</em></p>`;

                console.log('\n--- TEST 3: Text Generation ---');
                console.log(`Input Prompt: "${prompt}"`);
                console.log(`Generated Text: "${generatedText}"`);


            } catch (error) {
                updateStatus(3, 'ERROR! Check console.', 'error');
                console.error('Test 3 Error:', error);
            }
        }

        // --- Test 4: Reranking (Cross-Encoder) ---
        async function runRerankerTest() {
            updateStatus(4, 'Downloading and initializing Reranker Model (for RAG Accuracy)...');
            try {
                // Reranking uses the 'text-classification' task type
                const reranker = await pipeline('text-classification', 'Xenova/bge-reranker-base');
                updateStatus(4, 'Ready!', 'ready');

                const query = "How do I install the dependencies for a Python project?";
                const candidates = [
                    "Use `pip install -r requirements.txt` to install all project dependencies.",
                    "The project setup requires a version of NodeJS above 18.0.",
                ];
                
                // Crucial step: The input is an array of [query, document] pairs
                const scores = await reranker(candidates.map(doc => [query, doc]));

                const rerankedResults = scores
                    .map((score, index) => ({
                        score: score.score,
                        text: candidates[index],
                    }))
                    .sort((a, b) => b.score - a.score); // Sort by score, descending

                const topResult = rerankedResults[0];

                document.getElementById('result4').innerHTML = 
                    `<p><strong>Candidate 1 Score:</strong> ${rerankedResults.find(r => r.text === candidates[0]).score.toFixed(4)}</p>` +
                    `<p><strong>Candidate 2 Score:</strong> ${rerankedResults.find(r => r.text === candidates[1]).score.toFixed(4)}</p>` +
                    `<p><strong>Conclusion:</strong> The Reranker correctly identified the top result based on semantic relevance.</p>`;
                
                console.log('\n--- TEST 4: Reranking Results (Highest Score = Most Relevant) ---');
                rerankedResults.forEach((result, rank) => {
                    console.log(`Rank ${rank + 1} (Score: ${result.score.toFixed(4)}): "${result.text}"`);
                });

            } catch (error) {
                updateStatus(4, 'ERROR! Check console.', 'error');
                console.error('Test 4 Error:', error);
            }
        }


        // --- Main Execution Loop ---
        async function runAllModelTests() {
            // These run in parallel to load faster, but Test 4 is the most important for accuracy!
            await Promise.all([
                runFeatureExtractionTest(),
                runSentimentAnalysisTest(),
                runTextGenerationTest(),
                runRerankerTest(),
            ]);
            
            console.log('\nâœ… All core RAG model tests have completed successfully!');
        }

        // Start the tests!
        runAllModelTests();
    </script>
</body>
</html>
